# Dockerfile.artifacts - Build image from pre-built binaries (no Rust compile in Docker)
#
# Use when binaries are built in CI and passed as build context.
# Faster and more reliable than compiling inside Docker (no OOM, no mold/linker issues).
#
# Expected context layout (from release-artifacts workflow):
#   binaries/linux-amd64/vectorizer
#   binaries/linux-arm64/vectorizer
#   dashboard/dist/   (from build-dashboard artifact)
#   config.example.yml (from repo)
#
# Build (CI): docker buildx build -f Dockerfile.artifacts --platform linux/amd64,linux/arm64 .

# Stage: fix binary permissions + create writable data dir for nonroot (65532)
ARG TARGETARCH
FROM debian:bookworm-slim AS binary-with-perms
ARG TARGETARCH
COPY binaries/linux-${TARGETARCH}/vectorizer /vectorizer/vectorizer
RUN chmod +x /vectorizer/vectorizer

# Stage: writable dirs for distroless nonroot (no shell in final image to mkdir/chown)
FROM debian:bookworm-slim AS writable-dirs
RUN mkdir -p /vectorizer/data && chown -R 65532:65532 /vectorizer

# ============================================================================
# RUNTIME IMAGE - Google Distroless (minimal attack surface)
# ============================================================================
FROM gcr.io/distroless/cc-debian12:nonroot AS vectorizer

# Buildx sets TARGETARCH (amd64, arm64)
ARG TARGETARCH
ARG BUILD_DATE
ARG GIT_COMMIT_ID

# Copy binary with execute permission from intermediate stage
COPY --from=binary-with-perms /vectorizer/vectorizer /vectorizer/vectorizer
COPY dashboard/dist /vectorizer/dashboard/dist
COPY config.example.yml /vectorizer/config.yml
# Writable data dir for nonroot (binary creates ./data on startup; without this it exits)
COPY --from=writable-dirs --chown=65532:65532 /vectorizer/data /vectorizer/data

WORKDIR /vectorizer

ENV TZ=Etc/UTC \
    RUN_MODE=production \
    VECTORIZER_HOST=0.0.0.0 \
    VECTORIZER_PORT=15002 \
    VECTORIZER_ADMIN_USERNAME=admin

EXPOSE 15002

LABEL org.opencontainers.image.title="Vectorizer"
LABEL org.opencontainers.image.description="Official Vectorizer image - High-Performance Vector Database"
LABEL org.opencontainers.image.url="https://github.com/hivellm/vectorizer"
LABEL org.opencontainers.image.source="https://github.com/hivellm/vectorizer"
LABEL org.opencontainers.image.vendor="HiveLLM"
LABEL org.opencontainers.image.version="${GIT_COMMIT_ID:-latest}"
LABEL org.opencontainers.image.revision="${GIT_COMMIT_ID:-unknown}"
LABEL org.opencontainers.image.created="${BUILD_DATE:-unknown}"
LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL org.opencontainers.image.base.name="gcr.io/distroless/cc-debian12:nonroot"
LABEL security.scan.enabled="true"
LABEL security.non-root-user="nonroot"
LABEL security.user-id="65532"

ENTRYPOINT ["/vectorizer/vectorizer"]
