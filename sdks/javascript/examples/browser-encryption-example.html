<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vectorizer Encryption Example - Browser</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 30px;
    }
    .key-display {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
      border-left: 4px solid #3498db;
    }
    .button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: background 0.3s;
    }
    .button:hover {
      background: #2980b9;
    }
    .button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .status {
      margin: 15px 0;
      padding: 12px;
      border-radius: 4px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px 0;
      font-family: inherit;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #2c3e50;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Vectorizer Encryption Demo</h1>

    <div class="warning">
      <strong>‚ö†Ô∏è Security Notice:</strong> This is a demo. In production, never expose private keys in the browser.
      Use secure key storage (e.g., hardware security modules, secure enclaves).
    </div>

    <h2>Step 1: Generate ECC P-256 Key Pair</h2>
    <p>Generate a cryptographic key pair for encrypting your data.</p>
    <button class="button" onclick="generateKeys()">Generate Keys</button>

    <div id="keyDisplay" style="display: none;">
      <h3>Public Key (share with server)</h3>
      <div class="key-display" id="publicKeyDisplay"></div>

      <h3>Private Key (keep secret!)</h3>
      <div class="key-display" id="privateKeyDisplay"></div>
    </div>

    <h2>Step 2: Configure Connection</h2>
    <label for="serverUrl">Vectorizer Server URL:</label>
    <input type="text" id="serverUrl" value="http://localhost:15002" placeholder="http://localhost:15002">

    <label for="collectionName">Collection Name:</label>
    <input type="text" id="collectionName" value="browser-encrypted-demo" placeholder="browser-encrypted-demo">

    <h2>Step 3: Insert Encrypted Data</h2>
    <label for="documentText">Document Text (will be encrypted):</label>
    <textarea id="documentText" rows="4" placeholder="Enter sensitive text to encrypt...">This is confidential information that will be encrypted before storage.</textarea>

    <button class="button" onclick="insertEncryptedData()">Insert with Encryption</button>

    <h2>Step 4: Upload Encrypted File</h2>
    <label for="fileInput">Select File:</label>
    <input type="file" id="fileInput" accept=".txt,.md,.js,.ts,.json,.yaml,.yml">

    <button class="button" onclick="uploadEncryptedFile()">Upload with Encryption</button>

    <div id="status"></div>
  </div>

  <script>
    let publicKey = null;
    let privateKey = null;
    let publicKeyPEM = null;

    /**
     * Generate ECC P-256 key pair using Web Crypto API
     */
    async function generateKeys() {
      try {
        showStatus('Generating keys...', 'info');

        const keyPair = await window.crypto.subtle.generateKey(
          {
            name: 'ECDH',
            namedCurve: 'P-256'
          },
          true,
          ['deriveKey', 'deriveBits']
        );

        publicKey = keyPair.publicKey;
        privateKey = keyPair.privateKey;

        // Export public key in SPKI format
        const exportedPublicKey = await window.crypto.subtle.exportKey('spki', publicKey);

        // Convert to PEM format
        publicKeyPEM = arrayBufferToPEM(exportedPublicKey, 'PUBLIC KEY');

        // Display keys
        document.getElementById('publicKeyDisplay').textContent = publicKeyPEM;
        document.getElementById('privateKeyDisplay').textContent = 'Private key stored in memory (not displayed for security)';
        document.getElementById('keyDisplay').style.display = 'block';

        showStatus('‚úì Keys generated successfully!', 'success');
      } catch (error) {
        showStatus('Error generating keys: ' + error.message, 'error');
      }
    }

    /**
     * Convert ArrayBuffer to PEM format
     */
    function arrayBufferToPEM(buffer, label) {
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
      const formatted = base64.match(/.{1,64}/g).join('\n');
      return `-----BEGIN ${label}-----\n${formatted}\n-----END ${label}-----`;
    }

    /**
     * Insert encrypted data via REST API
     */
    async function insertEncryptedData() {
      if (!publicKeyPEM) {
        showStatus('Please generate keys first!', 'error');
        return;
      }

      const serverUrl = document.getElementById('serverUrl').value;
      const collectionName = document.getElementById('collectionName').value;
      const text = document.getElementById('documentText').value;

      try {
        showStatus('Creating collection...', 'info');

        // Create collection (ignore if exists)
        try {
          await fetch(`${serverUrl}/collections`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: collectionName,
              dimension: 384,
              metric: 'cosine'
            })
          });
        } catch (e) {
          // Collection might already exist
        }

        showStatus('Inserting encrypted document...', 'info');

        // Insert with encryption
        const response = await fetch(`${serverUrl}/collections/${collectionName}/vectors`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            texts: [{
              id: `doc-${Date.now()}`,
              text: text,
              metadata: {
                timestamp: new Date().toISOString(),
                encrypted: true
              }
            }],
            public_key: publicKeyPEM
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const result = await response.json();
        showStatus(`‚úì Successfully inserted encrypted document! Inserted: ${result.inserted || result.inserted_count || 1}`, 'success');
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    /**
     * Upload encrypted file
     */
    async function uploadEncryptedFile() {
      if (!publicKeyPEM) {
        showStatus('Please generate keys first!', 'error');
        return;
      }

      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files || fileInput.files.length === 0) {
        showStatus('Please select a file!', 'error');
        return;
      }

      const serverUrl = document.getElementById('serverUrl').value;
      const collectionName = document.getElementById('collectionName').value;
      const file = fileInput.files[0];

      try {
        showStatus('Creating collection...', 'info');

        // Create collection (ignore if exists)
        try {
          await fetch(`${serverUrl}/collections`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: collectionName,
              dimension: 384,
              metric: 'cosine'
            })
          });
        } catch (e) {
          // Collection might already exist
        }

        showStatus('Uploading encrypted file...', 'info');

        // Create FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('collection_name', collectionName);
        formData.append('public_key', publicKeyPEM);
        formData.append('metadata', JSON.stringify({
          encrypted: true,
          uploadedAt: new Date().toISOString()
        }));

        const response = await fetch(`${serverUrl}/files/upload`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const result = await response.json();
        showStatus(
          `‚úì File uploaded successfully!\n` +
          `- Chunks: ${result.chunks_created}\n` +
          `- Vectors: ${result.vectors_created}\n` +
          `- All payloads encrypted!`,
          'success'
        );
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
      }
    }

    /**
     * Show status message
     */
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }
  </script>
</body>
</html>
